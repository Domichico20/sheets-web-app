<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Google Sheets Manager</title>
  <!-- Preload login background -->
  <link rel="preload" as="image" href="bg.jpg">
  <!-- Preload app background -->
  <link rel="preload" as="image"
    href="https://raw.githubusercontent.com/Domichico20/sheets-web-app/main/pexels-codioful-6985045.jpg">


  <link rel="preload" as="image" href="logo.png">
  <link rel="preload" as="image" href="https://raw.githubusercontent.com/Domichico20/sheets-web-app/main/logo.png">
  <link rel="icon" type="image/png"
    href="https://raw.githubusercontent.com/Domichico20/sheets-web-app/main/1%20logo.png?v=12">
  <link rel="shortcut icon" type="image/png"
    href="https://raw.githubusercontent.com/Domichico20/sheets-web-app/main/1%20logo.png?v=12">
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/Domichico20/sheets-web-app/main/logo.png?v=6">





  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- speed: warm up API connections -->
  <link rel="preconnect" href="https://sheets.googleapis.com" crossorigin>
  <link rel="dns-prefetch" href="https://sheets.googleapis.com">
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="dns-prefetch" href="https://script.google.com">



  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', Arial, sans-serif;
    }

    body {
      margin: 20px;
      background-color: #f0f0f0;
    }

    header {
      text-align: center;
      margin-bottom: 20px;
      position: relative;
      z-index: 2;
    }

    header img.logo {
      max-width: 200px;
      height: auto;
    }

    h2 {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 1.75rem;
      font-weight: 600;
      text-align: center;
      margin-bottom: 20px;
      background: linear-gradient(90deg,
          #003366, #0066CC, #3399FF, #ff3333, #ffa733, #9a9c21, #54cc25, #1a8371, #229ea7, #33b4ff, #339cff);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradientShift 10s linear infinite;
    }

    @media (prefers-reduced-motion: reduce) {
      h2 {
        animation: none;
      }
    }

    @keyframes gradientShift {
      0% { background-position: 0% center; }
      100% { background-position: 200% center; }
    }

    /* --- Login section as a centered card --- */
    #loginSection {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      /* ⬅️ no vertical centering */
      padding: 8px 16px 40px;
      /* small top padding only */
      min-height: auto;
      /* ⬅️ remove forced height */
    }

    .login-card { margin-top: 4px; }

    .login-card {
      position: relative;
      width: min(420px, 92vw);
      padding: 28px 24px;
      background: rgba(255, 255, 255, 0.92);
      border-radius: 16px;
      border: 1px solid rgba(0, 0, 0, 0.06);
      box-shadow: 0 20px 60px rgba(0, 0, 0, .15);
      backdrop-filter: blur(6px);
    }

    .login-card::before {
      content: "";
      position: absolute;
      inset: -2px;
      border-radius: inherit;
      background: linear-gradient(45deg,
          #FF0000, #FF7300, #FFFB00, #48FF00,
          #00FFD5, #002BFF, #FF00C8, #FF0000);
      background-size: 600%;
      filter: blur(14px);
      z-index: -1;
      opacity: .30;
      animation: glowRainbow 20s linear infinite;
    }

    .login-card .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 1.25rem;
      margin-bottom: 14px;
      color: #003366;
    }

    .inputbox { position: relative; margin: 12px 0 6px; }

    .inputbox input {
      width: 100%;
      padding: 14px 12px;
      font-size: 1rem; /* >=16px on most browsers => no iOS zoom */
      border: 1px solid #d6d6d6;
      border-radius: 12px;
      outline: none;
      background: #fff;
    }

    .inputbox label {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: #fff;
      padding: 0 6px;
      color: #666;
      pointer-events: none;
      transition: .18s ease;
    }

    .inputbox input:focus+label,
    .inputbox input:not(:placeholder-shown)+label {
      top: 0;
      font-size: .8rem;
      color: #003366;
    }

    /* ========= Shared glow animation ========= */
    @keyframes glowRainbow {
      0% { background-position: 0 0; }
      50% { background-position: 400% 0; }
      100% { background-position: 0 0; }
    }

    /* Unlock button base */
    #loginSection .unlock-btn {
      margin-left: 0;
      padding: 15px 40px;
      border: none;
      outline: none;
      cursor: pointer;
      position: relative;
      border-radius: 12px;
      background-color: #2952db;
      color: #FFF;
      font-size: 1.1rem;
      isolation: isolate;
      width: 100%;
      margin-top: 14px;
    }

    /* ====== Rest of your styles (unchanged) ====== */
    #searchSection {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 20px;
    }

    #searchSection input[type="text"] {
      flex: 0 0 50%;
      max-width: 600px;
      padding: 10px;
      font-size: 1rem;
      border: 1px solid #d6d6d6;
      border-radius: 12px;
    }

    #searchSection button.search-btn {
      padding: 20px 40px;
      font-size: 1.25rem;
      margin-left: 20px;
      background-color: #92e67d;
      border-radius: 12px;
      border: none;
    }

    .add-note-btn { background-color: #6934be; color: #fff; }
    .critical-btn { background-color: #fc933d; color: #fff; }

    .form-section {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
      justify-content: center;
    }

    .form-group { display: flex; flex-direction: column; }
    .form-group label { font-weight: bold; margin-bottom: 5px; }
    .form-group input {
      padding: 10px;
      font-size: 1rem;
      width: 175px;
      border: 1px solid #d6d6d6;
      border-radius: 12px;
    }

    .button-row {
      display: flex;
      align-items: center;
      justify-content: center; /* center the whole bar */
      margin: 20px 0;
    }

    .button-group.center {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: nowrap; /* keep on one line */
    }

    /* If the screen is small, allow wrapping (optional) */
    @media (max-width: 700px) {
      .button-group.center {
        flex-wrap: wrap;
        justify-content: center;
      }
    }

    .button-group { display: flex; gap: 10px; }
    .button-group button {
      padding: 20px 40px;
      font-size: 1.25rem;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }

    .add-btn    { background-color: #003366; }
    .edit-btn   { background-color: #3399FF; }
    .clear-btn  { background-color: #66CC66; }
    .refresh-btn{ background-color: gold; color: black; }
    .delete-btn { background-color: red; }

    table {
      margin: 0 auto;
      width: auto;
      border-collapse: separate;
      border-spacing: 0;
      background: white;
      border-radius: 12px;
      overflow: hidden;
    }

    table th:nth-child(3),
    table td:nth-child(3) {
      max-width: 250px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    table th,
    table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      white-space: nowrap;
    }

    table th { background-color: #4285F4; color: white; }
    tr.selected { background-color: rgb(238, 217, 217); }

    /* ========= SAME gradient glow for ALL buttons ========= */
    .button-group button,
    #searchSection .search-btn,
    #loginSection .unlock-btn {
      position: relative;
      isolation: isolate;
      z-index: 0;
    }

    .button-group button::before,
    #searchSection .search-btn::before,
    #loginSection .unlock-btn::before {
      content: "";
      position: absolute;
      inset: -2px;
      border-radius: inherit;
      background: linear-gradient(45deg,
          #FF0000, #FF7300, #FFFB00, #48FF00,
          #00FFD5, #002BFF, #FF00C8, #FF0000);
      background-size: 600%;
      filter: blur(8px);
      animation: glowRainbow 20s linear infinite;
      transition: opacity .3s ease-in-out;
      opacity: 0;
      z-index: -1;
    }

    .button-group button:hover::before,
    #searchSection .search-btn:hover::before,
    #loginSection .unlock-btn:hover::before {
      opacity: 1;
    }

    /* --- Notes wrapping + scroll + WhatsApp link styling --- */
    table th:nth-child(7),
    table td:nth-child(7) { width: 550px; }

    .notes-cell {
      max-height: 180px;
      overflow: auto;
      white-space: normal;
      line-height: 1.35;
    }

    .note-entry { margin: 0 0 .55em 0; }
    .note-entry .ts { font-weight: 100; color: #880000; font-size: 1.05rem; }

    /* 🔴 Critical alert highlight */
    .note-entry.critical {
      background: #d93025; /* Google red */
      color: #fff;
      font-weight: 700;
      border-radius: 10px;
      padding: 6px 10px;
      display: inline-block;
    }

    .phone-wa a { text-decoration: none; }

    /* Make the Notes input wider */
    #notes { width: 500px; }

    /* Optional: keep it fluid on small screens */
    @media (max-width: 600px) {
      #notes { width: 100%; }
    }

    /* ===== Login-only background (uses bg.jpg) ===== */
    body.login-bg {
      min-height: 100vh;
      background: url('bg.jpg') center / cover no-repeat;
    }

    /* subtle dark overlay to boost contrast behind the card */
    body.login-bg::before {
      content: "";
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .35);
      pointer-events: none;
      z-index: -1;
    }

    /* ===== App (2nd page) background ===== */
    body.app-bg {
      min-height: 100vh;
      background: url('pexels-codioful-6985045.jpg') center / cover no-repeat;
    }

    /* Hide the app by default; only show it after login when body.app-bg is set */
    #appSection { display: none; }
    body.app-bg #appSection { display: block; }

    /* =========================================================
       ✅ MOBILE + PERFORMANCE ADDITIONS (ONLY NEW STUFF BELOW)
       ========================================================= */

    /* Touch targets & smoother taps */
    .button-group button,
    #searchSection .search-btn,
    #loginSection .unlock-btn {
      min-height: 44px;             /* thumb-friendly */
      will-change: transform;       /* (the line that was cut off) */
      -webkit-tap-highlight-color: transparent;
    }

    /* Make the table paint faster and scroll nicely on mobile */
    #dataTable {
      content-visibility: auto;                 /* paint only when visible */
      contain-intrinsic-size: 600px 400px;      /* reserve size for faster paint */
    }

    @media (max-width: 900px) {
      body { margin: 10px; }
      header img.logo { max-width: 150px; }
    }

    @media (max-width: 768px) {
      /* Stack the search bar */
      #searchSection { 
        flex-direction: column; 
        align-items: stretch; 
        gap: 10px; 
      }
      #searchSection input[type="text"] {
        flex: 1 1 auto;
        max-width: none;
        width: 100%;
      }
      #searchSection button.search-btn {
        margin-left: 0;
        width: 100%;
        padding: 14px;
        font-size: 1.05rem;
      }

      /* Inputs full-width in small screens */
      .form-group input { width: 100%; }

      /* Button group wraps nicely */
      .button-group.center { flex-wrap: wrap; }
      .button-group.center button {
        flex: 1 1 48%;
        padding: 14px 16px;
        font-size: 1rem;
      }

      /* Table horizontal scroll instead of squeezing columns */
      table { width: 100%; }
      #dataTable {
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      #dataTable thead,
      #dataTable tbody,
      #dataTable tr,
      #dataTable th,
      #dataTable td {
        white-space: nowrap;
      }
      table th:nth-child(7),
      table td:nth-child(7) { width: auto; }
      .notes-cell { max-height: 120px; }
    }

    @media (max-width: 480px) {
      .login-card { width: 100%; padding: 20px 16px; }
      .button-group.center button { flex-basis: 100%; }
      h2 { font-size: 1.25rem; }
    }

    /* Disable heavy glow/animation on phones & reduced motion for snappier taps */
    @media (prefers-reduced-motion: reduce), (max-width: 768px) {
      h2 { animation: none !important; }
      .button-group button::before,
      #searchSection .search-btn::before,
      #loginSection .unlock-btn::before,
      .login-card::before {
        display: none !important;   /* remove blurred gradient layer */
        animation: none !important;
      }
    }
  </style>
</head>


<body>
  <header>
    <img src="https://raw.githubusercontent.com/Domichico20/sheets-web-app/main/logo.png" alt="Company Logo"
      class="logo" width="200" height="200" decoding="async" fetchpriority="high" referrerpolicy="no-referrer"
      onerror="this.onerror=null; this.src='https://raw.githubusercontent.com/Domichico20/sheets-web-app/main/1%20logo.png';">
  </header>



  <div id="loginSection">
    <div class="login-card">
      <h1 class="brand">
        <svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"
          style="margin-right:4px;color:#2952db">
          <path
            d="M6 10V8a6 6 0 1112 0v2h1a1 1 0 011 1v10a1 1 0 01-1 1H5a1 1 0 01-1-1V11a1 1 0 011-1h1zm2 0h8V8a4 4 0 10-8 0v2z" />
        </svg>
        Osvaldo Nuñez
      </h1>

      <div class="inputbox">
        <input type="password" id="appPassword" placeholder=" "
          onkeydown="if(event.key==='Enter'){event.preventDefault();checkPassword();}">
        <label for="appPassword">Enter Password</label>
      </div>

      <button class="unlock-btn" onclick="checkPassword()">Unlock</button>
    </div>
  </div>

  <!-- App UI: hidden by CSS until body gets class 'app-bg' after login -->
  <div id="appSection">
    <form id="searchForm" onsubmit="event.preventDefault(); searchData();">
      <div id="searchSection">
        <input type="text" id="searchQuery" placeholder="Search by username, phone, or email">
        <button type="submit" class="search-btn">Search</button>
      </div>
    </form>

    <div class="form-section">
      <div class="form-group"><label for="username">Username:</label><input type="text" id="username"></div>
      <div class="form-group"><label for="password">Password:</label><input type="text" id="password"></div>
      <div class="form-group"><label for="email">Email:</label><input type="text" id="email"></div>
      <div class="form-group"><label for="phone">Phone #:</label><input type="text" id="phone"></div>
      <div class="form-group"><label for="server">Server:</label><input type="text" id="server"></div>
      <div class="form-group"><label for="autoPay">AutoPay:</label><input type="text" id="autoPay"></div>
      <div class="form-group">
        <label for="notes">Notes:</label>
        <input type="text" id="notes">
      </div>
      <input type="hidden" id="rowIndex" />
    </div>

    <div class="button-row">
      <div class="button-group center">
        <button class="add-btn" onclick="addRow()">Add</button>
        <button class="edit-btn" onclick="confirmEdit()">Edit</button>
        <button class="clear-btn" onclick="clearForm()">Clear</button>
        <button class="refresh-btn" onclick="loadData(true)">Refresh</button>
        <button class="delete-btn" onclick="confirmDelete()">Delete</button>
        <button type="button" class="add-note-btn" onclick="addNewNote()">Add New Note</button>
        <button type="button" class="critical-btn" onclick="addCriticalAlert()">Add Critical Alert</button>
      </div>
    </div>


    <table id="dataTable">
      <thead>
        <tr>
          <th>Username</th>
          <th>Password</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Server</th>
          <th>AutoPay</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    /* ---------- Login background on first load ---------- */
    document.addEventListener('DOMContentLoaded', () => {
      document.body.classList.add('login-bg');
    });

    /* ---------- App constants ---------- */
    const ROW_LIMIT = 25;
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzB8lRPMU0nZRSoU6CoRL_fcYstdq9pWPeZKdwuSp6O0QSsa95Oh49UnfV6uB9wt9w/exec';
    const sheetId = '1IR2TT4isrhET-3krSHV1BC8mE6xAhy0MEnR0h5-xBzs';
    const apiKey = 'AIzaSyC5rmJA1nl0LRhbGe-TsZwOSBfP97SzsHk';
    const range = 'data!A1:G3000';

    let sessionPassword = "";
    let selectedRowIndex = null;   // 1-based sheet row
    let selectedRawNotes = '';
    let existingUsernames = [];
    let allRecords = [];           // { row:[...], sheetRow:Number, lastEditMs:Number }
    let totalRows = 0;

    // speed helper: disable/enable a button by selector (prevents double submits)
    function setBusy(selector, on) {
      const btn = document.querySelector(selector);
      if (btn) btn.disabled = !!on;
    }

    /* ---------- Login ---------- */
    function checkPassword() {
      const pass = document.getElementById('appPassword').value.trim();
      if (pass === 'Google#2020') {
        sessionPassword = pass;
        document.body.classList.remove('login-bg');
        document.body.classList.add('app-bg');
        document.getElementById('loginSection').style.display = 'none';
        loadData();
      } else {
        alert('Incorrect password');
      }
    }
    window.checkPassword = checkPassword; // keep inline onclick working

    /* ---------- Helpers (formatting + search) ---------- */
    const TS_REGEX = /^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s\d{1,2},\s\d{4},?\s\d{2}:\d{2}\s(?:AM|PM)/;

    function parseLastEditMs(notesCell) {
      if (!notesCell) return 0;
      const firstLine = String(notesCell).split('\n')[0].trim();
      const m = firstLine.match(TS_REGEX);
      if (!m) return 0;
      const ms = Date.parse(m[0]);
      return isNaN(ms) ? 0 : ms;
    }

    function escapeHTML(s) {
      return String(s ?? '').replace(/[&<>"']/g, c =>
        ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
    }

    function normalizePhone(s) {
      const d = (s || '').replace(/\D/g, '');
      if (d.length === 10) return d.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3');
      if (d.length === 11 && d.startsWith('1'))
        return d.replace(/^1(\d{3})(\d{3})(\d{4})/, '1 ($1) $2-$3');
      return s || '';
    }

    function digitsOnly(s) { return (s || '').replace(/\D/g, ''); }

    function phoneLink(s) {
      const d = digitsOnly(s);
      if (!d) return '';
      const wa = (d.length === 10) ? ('1' + d) : (d.length === 11 && d.startsWith('1') ? d : d);
      const display = normalizePhone(s);
      return `<a href="https://wa.me/${wa}" target="_blank" rel="noopener" title="Message on WhatsApp">${escapeHTML(display)} 📲</a>`;
    }

    function canonicalEmail(s) {
      return (s || '')
        .toLowerCase()
        .replace(/^mailto:\s*/, '')
        .replace(/^mail\s*to:\s*/, '')
        .replace(/\s+/g, '')
        .trim();
    }

    function formatNotes(cell) {
      const stripped = (cell || '').replace(/#\d+:\s*/g, '').trim();
      if (!stripped) return '';

      // Render line by line so we can style CRITICAL alerts too
      const lines = stripped.split('\n');
      return lines
        .map(line => {
          // 🔴 Critical alert line
          const c = line.match(/^\[CRITICAL_ALERT\]\s*(.*)$/);
          if (c) {
            const msg = c[1] || '';
            return `<div class="note-entry critical">CRITICAL ALERT: ${escapeHTML(msg)}</div>`;
          }

          // Normal timestamped note line
          const m = line.match(/^((?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s\d{1,2},\s\d{4},?\s\d{2}:\d{2}\s(?:AM|PM)):\s*(.*)$/);
          if (!m) return `<div class="note-entry"><span class="txt">${escapeHTML(line)}</span></div>`;
          return `<div class="note-entry"><span class="ts">${escapeHTML(m[1])}</span>: <span class="txt">${escapeHTML(m[2])}</span></div>`;
        })
        .join('');
    }

    /* helper: prompt for CRITICAL alert on a given record and let user keep/delete */
    function promptCriticalAlert(rec) {
      const noteCell = (rec && rec.row && rec.row[6]) ? rec.row[6] : '';
      const m = (noteCell || '').match(/\[CRITICAL_ALERT\]\s*(.+)/);
      if (!m) return;

      const message = m[1].trim();
      // OK = Keep Alert, Cancel = Delete Alert
      setTimeout(() => {
        const keep = confirm(`⚠️ CRITICAL ALERT\n\n${message}\n\nOK = Keep Alert\nCancel = Delete Alert`);
        if (!keep) {
          const cleaned = (noteCell || '')
            .split('\n')
            .filter(line => !line.startsWith('[CRITICAL_ALERT]'))
            .join('\n');

          const row = rec.row;
          const params = new URLSearchParams({
            action: 'edit',
            password: sessionPassword,
            row: rec.sheetRow,
            username: row[0] || '',
            passwordField: row[1] || '',
            email: row[2] || '',
            phone: normalizePhone(row[3] || ''),
            server: row[4] || '',
            autoPay: row[5] || '',
            notes: cleaned
          });

          fetch(scriptURL, { method: 'POST', body: params })
            .then(r => r.text())
            .then(() => { alert('Critical alert removed.'); loadData(); })
            .catch(err => alert('Failed to update alert: ' + err));
        }
      }, 0);
    }


    /* ---------- Table cell renderer (restores your look) ---------- */
    function tdHTML(row) {
      return row.map((cell, ci) => {
        if (ci === 6) return '<td><div class="notes-cell">' + formatNotes(cell) + '</div></td>'; // Notes
        if (ci === 3) return '<td class="phone-wa">' + phoneLink(cell) + '</td>';                 // Phone
        return '<td>' + escapeHTML(cell) + '</td>';
      }).join('');
    }
    /* helper: prompt for CRITICAL alert on a given record and let user keep/delete */
    function promptCriticalAlert(rec) {
      const noteCell = (rec && rec.row && rec.row[6]) ? rec.row[6] : '';
      const m = (noteCell || '').match(/\[CRITICAL_ALERT\]\s*(.+)/);
      if (!m) return;

      const message = m[1].trim();
      // OK = Keep Alert, Cancel = Delete Alert
      setTimeout(() => {
        const keep = confirm(`⚠️ CRITICAL ALERT\n\n${message}\n\nOK = Keep Alert\nCancel = Delete Alert`);
        if (!keep) {
          const cleaned = (noteCell || '')
            .split('\n')
            .filter(line => !line.startsWith('[CRITICAL_ALERT]'))
            .join('\n');

          const row = rec.row;
          const params = new URLSearchParams({
            action: 'edit',
            password: sessionPassword,
            row: rec.sheetRow,
            username: row[0] || '',
            passwordField: row[1] || '',
            email: row[2] || '',
            phone: normalizePhone(row[3] || ''),
            server: row[4] || '',
            autoPay: row[5] || '',
            notes: cleaned
          });

          fetch(scriptURL, { method: 'POST', body: params })
            .then(r => r.text())
            .then(() => { alert('Critical alert removed.'); loadData(); })
            .catch(err => alert('Failed to update alert: ' + err));
        }
      }, 0);
    }

    /* ---------- Data load + render ---------- */
    function renderTable(records){
  const tbody = document.querySelector('#dataTable tbody');
  if (!tbody) return;
  tbody.innerHTML = '';
  const frag = document.createDocumentFragment();

  records.forEach(rec => {
    const row = rec.row;
    const tr = document.createElement('tr');
    tr.innerHTML = tdHTML(row);

    tr.addEventListener('click', () => {
      selectedRowIndex = rec.sheetRow; // exact sheet row for edit/delete
      document.querySelectorAll('#dataTable tr.selected').forEach(r => r.classList.remove('selected'));
      tr.classList.add('selected');

      ['username','password','email','phone','server','autoPay'].forEach((id, idx) => {
        const el = document.getElementById(id);
        if (el) el.value = row[idx] || '';
      });

      selectedRawNotes = row[6] || '';
      const notesEl = document.getElementById('notes');
      if (notesEl) notesEl.value = '';
      const idxEl = document.getElementById('rowIndex');
      if (idxEl) idxEl.value = selectedRowIndex;

      // Prompt critical alert (guarded)
      if (typeof promptCriticalAlert === 'function') {
        try { promptCriticalAlert(rec); } catch (e) { console.warn('Alert prompt error:', e); }
      }
    });

    frag.appendChild(tr);
  });

  tbody.appendChild(frag);
}

    function loadData(onlySelected = false) {
  // If called with true (Refresh button), update ONLY the selected row,
  // then resort by latest change (any field) — no full table reload.
  if (onlySelected) {
    if (selectedRowIndex === null) { alert('Select a row first.'); return; }
    setBusy('.refresh-btn', true);

    const singleRange = `data!A${selectedRowIndex}:G${selectedRowIndex}`;
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(singleRange)}?key=${apiKey}`;

    fetch(url)
      .then(r => r.json())
      .then(data => {
        const row = (data && data.values && data.values[0]) ? data.values[0] : [];
        const newRow = [0,1,2,3,4,5,6].map(i => row[i] || '');

        // Update in-memory selection + notes cache
        selectedRawNotes = newRow[6] || '';

        // Update the matched record
        const rec = allRecords.find(r => r.sheetRow === selectedRowIndex);
        if (rec) {
          rec.row = newRow;
          rec.lastEditMs = Date.now(); // ► treat this as the latest change (any field)
        }

        // Update the visible selected table row immediately
        const selectedTr = document.querySelector('#dataTable tr.selected');
        if (selectedTr) selectedTr.innerHTML = tdHTML(newRow);

        // Resort by latest change and re-render the visible chunk (no full reload)
        allRecords.sort((a, b) => (b.lastEditMs - a.lastEditMs) || (b.sheetRow - a.sheetRow));
        renderTable(allRecords.slice(0, ROW_LIMIT));
      })
      .catch(err => {
        console.error(err);
        alert('Failed to refresh the selected row from Google Sheets.');
      })
      .finally(() => setBusy('.refresh-btn', false));

    return; // stop here; no full reload
  }

  // Original full reload (used elsewhere in the app)
  setBusy('.refresh-btn', true);
  fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`)
    .then(r => r.json())
    .then(data => {
      const rows = data.values || [];
      totalRows = rows.length;
      const dataRows = rows.slice(1); // skip header
      existingUsernames = dataRows.map(r => (r[0] || '').toLowerCase());

      allRecords = dataRows.map((row, idx) => ({
        row,
        sheetRow: idx + 2,                 // 1-based, +1 header
        lastEditMs: parseLastEditMs(row[6] || '')
      }));

      // Most recently edited first; tie-break by newest sheet row
      allRecords.sort((a, b) => (b.lastEditMs - a.lastEditMs) || (b.sheetRow - a.sheetRow));

      // Reset search box, render the top chunk
      const q = document.getElementById('searchQuery');
      if (q) q.value = '';
      const tbody = document.querySelector('#dataTable tbody');
      if (tbody) { tbody.innerHTML = ''; }
      renderTable(allRecords.slice(0, ROW_LIMIT));
    })
    .catch(err => {
      console.error(err);
      alert('Failed to load data from Google Sheets.');
    })
    .finally(() => setBusy('.refresh-btn', false));
}

window.loadData = loadData;

    /* ---------- Search (keeps your phone/email smarts) ---------- */
function searchData() {
  const raw = document.getElementById('searchQuery').value.trim().toLowerCase();
  if (!raw) { renderTable(allRecords.slice(0, ROW_LIMIT)); return; }

  const qDigits = (raw.match(/\d/g) || []).join('');
  const qEmail = canonicalEmail(raw);
  const hasPhoneQuery = qDigits.length >= 7;
  const hasEmailQuery = qEmail.includes('@');

  const filtered = allRecords.filter(rec => {
    const row = rec.row;
    const baseMatch = row.join(' ').toLowerCase().includes(raw);

    let phoneMatch = false;
    if (hasPhoneQuery) {
      const rp = (row[3] || '').replace(/\D/g, '');
      const last10 = s => s.slice(-10);
      if (rp) phoneMatch = rp.includes(qDigits) || last10(rp) === last10(qDigits);
    }

    let emailMatch = false;
    if (hasEmailQuery) {
      const re = canonicalEmail(row[2] || '');
      emailMatch = re.includes(qEmail);
    }

    return baseMatch || phoneMatch || emailMatch;
  });

  renderTable(filtered.slice(0, ROW_LIMIT));

  // If the search narrows to exactly one row and it has a CRITICAL alert, show it immediately
  // After rendering, if any matching row has a CRITICAL alert, prompt once.
  const alertRec = filtered.find(r => /\[CRITICAL_ALERT\]/.test((r.row[6] || '')));
  if (alertRec) { promptCriticalAlert(alertRec); }
}
window.searchData = searchData;



      /* ---------- Add/Edit/Delete (same behavior as before) ---------- */
      function clearForm() {
        ['username', 'password', 'email', 'phone', 'server', 'autoPay', 'notes', 'searchQuery']
          .forEach(id => { const e = document.getElementById(id); if (e) e.value = ''; });
        document.querySelectorAll('#dataTable tr.selected').forEach(r => r.classList.remove('selected'));
        selectedRowIndex = null;
      }
      window.clearForm = clearForm;

      function confirmDelete() {
        if (selectedRowIndex === null) { alert('Select a row first.'); return; }
        if (!confirm('Delete selected row?')) return;

        setBusy('.delete-btn', true);
        fetch(scriptURL, {
          method: 'POST',
          body: new URLSearchParams({ action: 'delete', password: sessionPassword, row: selectedRowIndex })
        })
          .then(res => res.text())
          .then(() => { selectedRowIndex = null; loadData(); })
          .catch(err => alert('Delete failed: ' + err))
          .finally(() => setBusy('.delete-btn', false));
      }




      window.confirmDelete = confirmDelete;

      function confirmEdit() {
        if (selectedRowIndex === null) { alert('Select a row first!'); return; }
        if (!confirm('Save changes to this row?')) return;
        editRow();
      }
      window.confirmEdit = confirmEdit;

      function editRow() {
  setBusy('.edit-btn', true);

  function gi(id) { return document.getElementById(id).value.trim(); }
  const rawNew = gi('notes');
  const existing = (selectedRawNotes || '').replace(/#\d+:\s*/g, '').trim();

  let combined = existing;
  if (rawNew) {
    const ts = new Date().toLocaleString('en-US', {
      timeZone: 'America/Chicago', // match server timezone used on Adds
      month: 'short', day: 'numeric', year: 'numeric',
      hour: '2-digit', minute: '2-digit'
    });
    combined = `${ts}: ${rawNew}` + (existing ? `\n${existing}` : '');
  }

  const params = new URLSearchParams({
    action: 'edit',
    password: sessionPassword,
    row: selectedRowIndex,
    username: gi('username'),
    passwordField: gi('password'),
    email: gi('email'),
    phone: normalizePhone(gi('phone')),
    server: gi('server'),
    autoPay: gi('autoPay'),
    notes: combined
  });

  // ✅ No page refresh: update UI + local cache, then resort by last change
  fetch(scriptURL, { method: 'POST', body: params })
    .then(r => r.text())
    .then(() => {
      // Build the updated row from inputs
      const newRow = [
        gi('username'),
        gi('password'),
        gi('email'),
        normalizePhone(gi('phone')),
        gi('server'),
        gi('autoPay'),
        combined
      ];

      // Update our in-memory state
      selectedRawNotes = combined;
      const rec = allRecords.find(r => r.sheetRow === selectedRowIndex);
      if (rec) {
        rec.row = newRow;
        rec.lastEditMs = Date.now(); // sort by latest change, regardless of field
      }

      // Update the currently selected table row in place
      const selectedTr = document.querySelector('#dataTable tr.selected');
      if (selectedTr) selectedTr.innerHTML = tdHTML(newRow);

      // Resort by last change and re-render the visible chunk (no network)
      allRecords.sort((a, b) => (b.lastEditMs - a.lastEditMs) || (b.sheetRow - a.sheetRow));
      renderTable(allRecords.slice(0, ROW_LIMIT));
    })
    .catch(err => alert('Edit failed: ' + err))
    .finally(() => setBusy('.edit-btn', false));
}

      function addNewNote() {
        if (selectedRowIndex === null) { alert('Select a row first.'); return; }
        const note = document.getElementById('notes').value.trim();
        if (!note) { alert('Type a note in the Notes box first.'); return; }
        editRow(); // will timestamp & prepend
      }
      window.addNewNote = addNewNote;

      function addRow() {
        setBusy('.add-btn', true);

        function gi(id) { return document.getElementById(id).value.trim(); }
        const username = gi('username');
        if (!username) { alert('Username is required.'); setBusy('.add-btn', false); return; }
        if (existingUsernames.includes(username.toLowerCase())) { alert('Username already exists'); setBusy('.add-btn', false); return; }

        const notesInput = gi('notes'); // server will attach its single timestamp
        const formattedNotes = notesInput ? `${notesInput}` : '';

        const data = {
          action: 'add',
          password: sessionPassword,
          username: username,
          passwordField: gi('password'),
          email: gi('email'),
          phone: normalizePhone(gi('phone')),
          server: gi('server'),
          autoPay: gi('autoPay'),
          notes: formattedNotes
        };

        fetch(scriptURL, { method: 'POST', body: new URLSearchParams(data) })
          .then(r => r.text())
          .then(() => { clearForm(); loadData(); })
          .catch(err => { console.error(err); alert('Error saving row.'); })
          .finally(() => setBusy('.add-btn', false));
      }


      window.addRow = addRow;
      function addCriticalAlert() {
  if (selectedRowIndex === null) { alert('Select a row first.'); return; }

  const msg = prompt('Enter the CRITICAL ALERT message for this row:');
  if (msg === null) return;                 // user canceled
  const trimmed = msg.trim();
  if (!trimmed) { alert('Alert message cannot be empty.'); return; }

  // Keep everything else in Notes, but ensure only one [CRITICAL_ALERT] line exists (always on top)
  const existing = (selectedRawNotes || '').replace(/#\d+:\s*/g, '').trim();
  const cleaned = existing
    .split('\n')
    .filter(line => !line.startsWith('[CRITICAL_ALERT]'))
    .join('\n');

  const combined = `[CRITICAL_ALERT] ${trimmed}` + (cleaned ? `\n${cleaned}` : '');

  const params = new URLSearchParams({
    action: 'edit',
    password: sessionPassword,
    row: selectedRowIndex,
    username: document.getElementById('username').value.trim(),
    passwordField: document.getElementById('password').value.trim(),
    email: document.getElementById('email').value.trim(),
    phone: normalizePhone(document.getElementById('phone').value.trim()),
    server: document.getElementById('server').value.trim(),
    autoPay: document.getElementById('autoPay').value.trim(),
    notes: combined
  });

  // ✅ No page refresh: update UI + local cache, then resort by last change
  fetch(scriptURL, { method: 'POST', body: params })
    .then(r => r.text())
    .then(() => {
      alert('Critical alert saved.');

      // Update our in-memory state + row UI
      selectedRawNotes = combined;

      const rec = allRecords.find(r => r.sheetRow === selectedRowIndex);
      if (rec) {
        const newRow = [
          document.getElementById('username').value.trim(),
          document.getElementById('password').value.trim(),
          document.getElementById('email').value.trim(),
          normalizePhone(document.getElementById('phone').value.trim()),
          document.getElementById('server').value.trim(),
          document.getElementById('autoPay').value.trim(),
          combined
        ];
        rec.row = newRow;
        rec.lastEditMs = Date.now(); // treat this as latest change
        const selectedTr = document.querySelector('#dataTable tr.selected');
        if (selectedTr) selectedTr.innerHTML = tdHTML(newRow);
      }

      // Resort by last change and re-render the visible chunk (no network)
      allRecords.sort((a, b) => (b.lastEditMs - a.lastEditMs) || (b.sheetRow - a.sheetRow));
      renderTable(allRecords.slice(0, ROW_LIMIT));
    })
    .catch(err => alert('Failed to save critical alert: ' + err));
}
window.addCriticalAlert = addCriticalAlert;

  </script>



</body>

</html>