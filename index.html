<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Google Sheets Manager</title>
  <!-- Preload login background -->
  <link rel="preload" as="image" href="bg.jpg">
  <!-- Preload app background -->
  <link rel="preload" as="image" href="https://raw.githubusercontent.com/Domichico20/sheets-web-app/main/pexels-codioful-6985045.jpg">

  <link rel="preload" as="image" href="logo.png">
  <link rel="preload" as="image" href="https://raw.githubusercontent.com/Domichico20/sheets-web-app/main/logo.png">
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Domichico20/sheets-web-app/main/1%20logo.png?v=12">
  <link rel="shortcut icon" type="image/png" href="https://raw.githubusercontent.com/Domichico20/sheets-web-app/main/1%20logo.png?v=12">
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/Domichico20/sheets-web-app/main/logo.png?v=6">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- speed: warm up API connections -->
  <link rel="preconnect" href="https://sheets.googleapis.com" crossorigin>
  <link rel="dns-prefetch" href="https://sheets.googleapis.com">
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="dns-prefetch" href="https://script.google.com">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', Arial, sans-serif;
    }

    body {
      margin: 20px;
      background-color: #f0f0f0;
    }

    header {
      text-align: center;
      margin-bottom: 20px;
      position: relative;
      z-index: 2;
    }

    header img.logo {
      max-width: 200px;
      height: auto;
    }

    h2 {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 1.75rem;
      font-weight: 600;
      text-align: center;
      margin-bottom: 20px;
      background: linear-gradient(90deg, #003366, #0066CC, #3399FF, #ff3333, #ffa733, #9a9c21, #54cc25, #1a8371, #229ea7, #33b4ff, #339cff);
      background-size: 200% auto;
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradientShift 10s linear infinite;
    }

    @media (prefers-reduced-motion: reduce) {
      h2 {
        animation: none;
      }
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .login-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 40px;
      text-align: center;
      color: white;
    }

    .login-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 30px;
      max-width: 400px;
      margin: 0 auto;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .login-card h3 {
      margin-bottom: 20px;
      font-size: 1.5rem;
    }

    .login-card input {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
    }

    .unlock-btn {
      background: linear-gradient(45deg, #ff6b6b, #ee5a24);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .unlock-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .main-content {
      padding: 30px;
    }

    .search-section {
      margin-bottom: 20px;
    }

    .search-section input[type="text"] {
      width: 70%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      margin-right: 10px;
    }

    .search-section button.search-btn {
      background: linear-gradient(45deg, #4ecdc4, #44a08d);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .search-section button.search-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .form-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }

    .form-group {
      flex: 1;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
    }

    .form-group input, .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    .form-group input:focus, .form-group textarea:focus {
      outline: none;
      border-color: #4ecdc4;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .button-row {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.1s ease;
      font-size: 14px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    button:active {
      transform: scale(0.98);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .add-btn    { background-color: #003366; }
    .edit-btn   { background-color: #3399FF; }
    .clear-btn  { background-color: #66CC66; }
    .refresh-btn{ background-color: gold; color: black; }
    .delete-btn { background-color: red; }
    .undo-btn { background-color: #FF6B35; }

    table {
      margin: 0 auto;
      width: auto;
      border-collapse: separate;
      border-spacing: 0;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 1px;
    }

    tr:hover {
      background-color: #f5f5f5;
    }

    tr.selected {
      background-color: #e3f2fd;
    }

    .critical-alert {
      background-color: #ffebee;
      color: #c62828;
      font-weight: bold;
      padding: 5px;
      border-left: 4px solid #f44336;
    }

    /* Modern Alert System Styles */
    .modern-alert {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      min-width: 300px;
      max-width: 500px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      border-left: 4px solid #007bff;
      animation: slideInRight 0.3s ease-out;
      font-family: 'Poppins', Arial, sans-serif;
    }

    .modern-alert-success { border-left-color: #28a745; }
    .modern-alert-error { border-left-color: #dc3545; }
    .modern-alert-warning { border-left-color: #ffc107; }
    .modern-alert-critical { border-left-color: #dc3545; background: #fff5f5; }
    .modern-alert-info { border-left-color: #17a2b8; }

    .alert-content {
      display: flex;
      align-items: center;
      padding: 16px;
      gap: 12px;
    }

    .alert-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .alert-message {
      flex: 1;
      font-size: 14px;
      line-height: 1.4;
      color: #333;
    }

    .alert-close {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #666;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.2s;
    }

    .alert-close:hover {
      background-color: #f0f0f0;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @media (max-width: 768px) {
      .form-row {
        flex-direction: column;
      }
      
      .button-group {
        justify-content: center;
      }
      
      .search-section input[type="text"] {
        width: 100%;
        margin-bottom: 10px;
        margin-right: 0;
      }
    }
  </style>
</head>
<body>
  <header>
    <img src="https://raw.githubusercontent.com/Domichico20/sheets-web-app/main/logo.png" alt="Logo" class="logo">
  </header>

  <div class="container">
    <div id="loginSection" class="login-section">
      <div class="login-card">
        <h3>üîê Secure Access</h3>
        <input type="password" id="passwordInput" placeholder="Enter password">
        <button class="unlock-btn" onclick="checkPassword()">Unlock</button>
      </div>
    </div>

    <div id="mainSection" class="main-content" style="display: none;">
      <h2>üìä Google Sheets Manager</h2>
      
      <form id="searchForm" onsubmit="event.preventDefault(); searchData();">
        <div id="searchSection">
          <input type="text" id="searchQuery" placeholder="Search by username, phone, or email">
          <button type="submit" class="search-btn">Search</button>
        </div>
      </form>

      <div class="form-section">
        <div class="form-row">
          <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" placeholder="Enter username">
          </div>
          <div class="form-group">
            <label for="passwordField">Password</label>
            <input type="text" id="passwordField" placeholder="Enter password">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" placeholder="Enter email">
          </div>
          <div class="form-group">
            <label for="phone">Phone</label>
            <input type="tel" id="phone" placeholder="Enter phone number">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="server">Server</label>
            <input type="text" id="server" placeholder="Enter server">
          </div>
          <div class="form-group">
            <label for="autoPay">Auto Pay</label>
            <input type="text" id="autoPay" placeholder="Enter auto pay info">
          </div>
        </div>
        
        <div class="form-group">
          <label for="notes">Notes</label>
          <textarea id="notes" placeholder="Enter notes or critical alerts"></textarea>
        </div>
      </div>

      <div class="button-row">
        <div class="button-group center">
          <button class="add-btn" onclick="addRow()">Add</button>
          <button class="edit-btn" onclick="confirmEdit()">Edit</button>
          <button class="clear-btn" onclick="clearForm()">Clear</button>
          <button class="refresh-btn" onclick="loadData(true)">Refresh</button>
          <button class="delete-btn" onclick="confirmDelete()">Delete</button>
          <button class="undo-btn" onclick="undoLastChange()">UNDO</button>
          <button type="button" class="add-note-btn" onclick="addNewNote()">Add New Note</button>
          <button type="button" class="critical-btn" onclick="addCriticalAlert()">Add Critical Alert</button>
          <button type="button" class="remove-alert-btn" onclick="removeCriticalAlert()">Remove Alert</button>
        </div>
      </div>

      <table id="dataTable">
        <thead>
          <tr>
            <th>Username</th>
            <th>Password</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Server</th>
            <th>Auto Pay</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Configuration
    const ROW_LIMIT = 25;
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzB8lRPMU0nZRSoU6CoRL_fcYstdq9pWPeZKdwuSp6O0QSsa95Oh49UnfV6uB9wt9w/exec';
    const sheetId = '1IR2TT4isrhET-3krSHV1BC8mE6xAhy0MEnR0h5-xBzs';
    const apiKey = 'AIzaSyC5rmJA1nl0LRhbGe-TsZwOSBfP97SzsHk';
    const range = 'data!A1:G3000';

    // Global variables
    let sessionPassword = "";
    let selectedRowIndex = null;  // 1-based sheet row
    let selectedRawNotes = '';
    let existingUsernames = [];
    let allRecords = [];          // { row:[...], sheetRow:Number, lastEditMs:Number }
    let totalRows = 0;

    // Performance optimization: Cache DOM elements
    const domCache = {
      searchQuery: null,
      username: null,
      passwordField: null,
      email: null,
      phone: null,
      server: null,
      autoPay: null,
      notes: null
    };

    function initDOMCache() {
      domCache.searchQuery = document.getElementById('searchQuery');
      domCache.username = document.getElementById('username');
      domCache.passwordField = document.getElementById('passwordField');
      domCache.email = document.getElementById('email');
      domCache.phone = document.getElementById('phone');
      domCache.server = document.getElementById('server');
      domCache.autoPay = document.getElementById('autoPay');
      domCache.notes = document.getElementById('notes');
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      initDOMCache();
    });

    // Search optimization
    let searchTimeout = null;
    function debounceSearch(func, delay = 300) {
      return function(...args) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    // Request caching for better performance
    const requestCache = new Map();
    const CACHE_DURATION = 5000; // 5 seconds

    function getCachedRequest(url) {
      const cached = requestCache.get(url);
      if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
        return cached.data;
      }
      return null;
    }

    function setCachedRequest(url, data) {
      requestCache.set(url, {
        data: data,
        timestamp: Date.now()
      });
    }

    // Utility functions
    function setBusy(selector, on) {
      const btn = document.querySelector(selector);
      if (btn) btn.disabled = !!on;
    }

    function setBusySafe(selector, on) {
      try {
        setBusy(selector, on);
      } catch (e) {
        console.warn('setBusy failed:', e);
      }
    }

    // Password check
    function checkPassword() {
      const password = document.getElementById('passwordInput').value;
      if (password === 'Google#2020') {
        sessionPassword = password;
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('mainSection').style.display = 'block';
        loadData();
      } else {
        showModernAlert('Incorrect password', 'error');
      }
    }

    // Data loading
    async function loadData(forceRefresh = false) {
      setBusySafe('#refreshBtn', true);
      
      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;
        
        if (!forceRefresh) {
          const cached = getCachedRequest(url);
          if (cached) {
            processData(cached);
            return;
          }
        }

        const response = await fetch(url);
        const data = await response.json();
        
        if (data.values) {
          setCachedRequest(url, data);
          processData(data);
        } else {
          showModernAlert('Failed to load data from Google Sheets.', 'error');
        }
      } catch (error) {
        console.error('Error loading data:', error);
        showModernAlert('Failed to load data from Google Sheets.', 'error');
      } finally {
        setBusySafe('#refreshBtn', false);
      }
    }

    function processData(data) {
      const rows = data.values || [];
      allRecords = [];
      existingUsernames = [];
      
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (row && row.length > 0) {
          const record = {
            row: row,
            sheetRow: i + 1,
            lastEditMs: Date.now()
          };
          allRecords.push(record);
          
          if (row[0]) {
            existingUsernames.push(row[0].toLowerCase());
          }
        }
      }
      
      totalRows = allRecords.length;
      renderTable(allRecords.slice(0, ROW_LIMIT));
    }

    function renderTable(records) {
      const tbody = document.querySelector('#dataTable tbody');
      tbody.innerHTML = '';
      
      records.forEach(record => {
        const row = document.createElement('tr');
        row.onclick = () => selectRow(record.sheetRow, record.row);
        
        for (let i = 0; i < 7; i++) {
          const cell = document.createElement('td');
          const cellValue = record.row[i] || '';
          
          if (i === 6 && cellValue.includes('üö® CRITICAL ALERT')) {
            cell.innerHTML = `<div class="critical-alert">${cellValue}</div>`;
          } else {
            cell.textContent = cellValue;
          }
          
          row.appendChild(cell);
        }
        
        tbody.appendChild(row);
      });
    }

    function selectRow(sheetRow, rowData) {
      selectedRowIndex = sheetRow;
      selectedRawNotes = rowData[6] || '';
      
      // Update form fields
      if (domCache.username) domCache.username.value = rowData[0] || '';
      if (domCache.passwordField) domCache.passwordField.value = rowData[1] || '';
      if (domCache.email) domCache.email.value = rowData[2] || '';
      if (domCache.phone) domCache.phone.value = rowData[3] || '';
      if (domCache.server) domCache.server.value = rowData[4] || '';
      if (domCache.autoPay) domCache.autoPay.value = rowData[5] || '';
      if (domCache.notes) domCache.notes.value = rowData[6] || '';
      
      // Update visual selection
      document.querySelectorAll('tr').forEach(tr => tr.classList.remove('selected'));
      event.currentTarget.classList.add('selected');
      
      // Show critical alert only when row is selected
      if (rowData[6] && rowData[6].includes('üö® CRITICAL ALERT')) {
        const alertMatch = rowData[6].match(/üö® CRITICAL ALERT: (.+?)(?=\n|$)/);
        if (alertMatch) {
          showModernAlert(alertMatch[1], 'critical');
        }
      }
    }

    function clearForm() {
      selectedRowIndex = null;
      selectedRawNotes = '';
      
      if (domCache.username) domCache.username.value = '';
      if (domCache.passwordField) domCache.passwordField.value = '';
      if (domCache.email) domCache.email.value = '';
      if (domCache.phone) domCache.phone.value = '';
      if (domCache.server) domCache.server.value = '';
      if (domCache.autoPay) domCache.autoPay.value = '';
      if (domCache.notes) domCache.notes.value = '';
      
      document.querySelectorAll('tr').forEach(tr => tr.classList.remove('selected'));
    }

    // Search functionality
    function canonicalEmail(email) {
      return (email || '').toLowerCase().trim();
    }

    function searchData() {
      // Clear input boxes when search is performed
      if (domCache.username) domCache.username.value = '';
      if (domCache.passwordField) domCache.passwordField.value = '';
      if (domCache.email) domCache.email.value = '';
      if (domCache.phone) domCache.phone.value = '';
      if (domCache.server) domCache.server.value = '';
      if (domCache.autoPay) domCache.autoPay.value = '';
      if (domCache.notes) domCache.notes.value = '';
      
      const raw = domCache.searchQuery.value.trim().toLowerCase();
      if (!raw) {
        renderTable(allRecords.slice(0, ROW_LIMIT));
        return;
      }

      // Pre-compile regex patterns for better performance
      const qDigits = (raw.match(/\d/g) || []).join('');
      const qEmail = canonicalEmail(raw);
      const hasPhoneQuery = qDigits.length >= 7;
      const hasEmailQuery = qEmail.includes('@');

      // Use for loop instead of filter for better performance on large datasets
      const filtered = [];
      for (let i = 0; i < allRecords.length; i++) {
        const rec = allRecords[i];
        const row = rec.row;
        const baseMatch = row.join(' ').toLowerCase().includes(raw);

        let phoneMatch = false;
        if (hasPhoneQuery) {
          const rp = (row[3] || '').replace(/\D/g, '');
          const last10 = s => s.slice(-10);
          if (rp) phoneMatch = rp.includes(qDigits) || last10(rp) === last10(qDigits);
        }

        let emailMatch = false;
        if (hasEmailQuery) {
          const re = canonicalEmail(row[2] || '');
          emailMatch = re.includes(qEmail);
        }

        if (baseMatch || phoneMatch || emailMatch) {
          filtered.push(rec);
        }
      }

      renderTable(filtered.slice(0, ROW_LIMIT));
    }

    // Create debounced version of search
    const debouncedSearch = debounceSearch(searchData, 300);
    window.searchData = searchData;
    window.debouncedSearch = debouncedSearch;

    // Add/Edit/Delete functions
    function confirmDelete() {
      if (selectedRowIndex === null) { 
        showModernAlert('Select a row first.', 'warning'); 
        return; 
      }
      
      if (!confirm('Delete selected row?')) return;
      
      setBusy('.delete-btn', true);
      fetch(scriptURL, {
        method: 'POST',
        body: new URLSearchParams({ action: 'delete', password: sessionPassword, row: selectedRowIndex })
      })
        .then(res => res.text())
        .then(data => {
          console.log('Delete response:', data);
          loadData(true);
          clearForm();
        })
        .catch(err => showModernAlert('Delete failed: ' + err, 'error'))
        .finally(() => setBusy('.delete-btn', false));
    }

    function confirmEdit() {
      if (selectedRowIndex === null) { 
        showModernAlert('Select a row first!', 'warning'); 
        return; 
      }
      
      if (!confirm('Save changes to this row?')) return;
      
      setBusy('.edit-btn', true);

      // Use cached DOM elements for better performance
      const rawNew = domCache.notes ? domCache.notes.value.trim() : '';
      const existing = (selectedRawNotes || '').replace(/#\d+:\s*/g, '').trim();

      const data = {
        action: 'edit',
        password: sessionPassword,
        row: selectedRowIndex,
        username: domCache.username ? domCache.username.value.trim() : '',
        passwordField: domCache.passwordField ? domCache.passwordField.value.trim() : '',
        email: domCache.email ? domCache.email.value.trim() : '',
        phone: domCache.phone ? domCache.phone.value.trim() : '',
        server: domCache.server ? domCache.server.value.trim() : '',
        autoPay: domCache.autoPay ? domCache.autoPay.value.trim() : '',
        notes: rawNew
      };

      fetch(scriptURL, {
        method: 'POST',
        body: new URLSearchParams(data)
      })
        .then(res => res.text())
        .then(data => {
          console.log('Edit response:', data);
          loadData(true);
        })
        .catch(err => showModernAlert('Edit failed: ' + err, 'error'))
        .finally(() => setBusy('.edit-btn', false));
    }

    function addNewNote() {
      if (selectedRowIndex === null) { 
        showModernAlert('Please select a row first', 'warning'); 
        return; 
      }
      
      const note = domCache.notes ? domCache.notes.value.trim() : '';
      if (!note) { 
        showModernAlert('Please enter a note', 'warning'); 
        return; 
      }
      
      const timestamp = new Date().toLocaleString('en-US', {
        month: 'short', day: 'numeric', year: 'numeric',
        hour: 'numeric', minute: '2-digit', hour12: true
      });
      
      const newNote = `${timestamp}: ${note}`;
      const currentNotes = domCache.notes ? domCache.notes.value : '';
      
      // Keep critical alert at the top if it exists
      if (currentNotes.includes('üö® CRITICAL ALERT')) {
        const criticalMatch = currentNotes.match(/üö® CRITICAL ALERT: .+?(?=\n\n|\n|$)/);
        if (criticalMatch) {
          const criticalAlert = criticalMatch[0];
          const otherNotes = currentNotes.replace(/üö® CRITICAL ALERT: .+?(?=\n\n|\n|$)/, '').trim();
          if (domCache.notes) domCache.notes.value = criticalAlert + '\n\n' + newNote + (otherNotes ? '\n\n' + otherNotes : '');
        } else {
          if (domCache.notes) domCache.notes.value = currentNotes + '\n\n' + newNote;
        }
      } else {
        if (domCache.notes) domCache.notes.value = currentNotes + (currentNotes ? '\n\n' : '') + newNote;
      }
      
      showModernAlert('Note added successfully', 'success');
    }

    function addRow() {
      if (sessionPassword) {
        setBusy('.add-btn', true);

        // Use cached DOM elements for better performance
        const username = domCache.username ? domCache.username.value.trim() : '';
        if (!username) { 
          showModernAlert('Username is required.', 'warning'); 
          setBusy('.add-btn', false); 
          return; 
        }
        if (existingUsernames.includes(username.toLowerCase())) { 
          showModernAlert('Username already exists', 'warning'); 
          setBusy('.add-btn', false); 
          return; 
        }

        const data = {
          action: 'add',
          password: sessionPassword,
          username: username,
          passwordField: domCache.passwordField ? domCache.passwordField.value.trim() : '',
          email: domCache.email ? domCache.email.value.trim() : '',
          phone: domCache.phone ? domCache.phone.value.trim() : '',
          server: domCache.server ? domCache.server.value.trim() : '',
          autoPay: domCache.autoPay ? domCache.autoPay.value.trim() : '',
          notes: domCache.notes ? domCache.notes.value.trim() : ''
        };

        fetch(scriptURL, {
          method: 'POST',
          body: new URLSearchParams(data)
        })
          .then(res => res.text())
          .then(data => {
            console.log('Add response:', data);
            loadData(true);
            clearForm();
          })
          .catch(err => { 
            console.error(err); 
            showModernAlert('Error saving row.', 'error'); 
          })
          .finally(() => setBusy('.add-btn', false));
      }
    }

    function addCriticalAlert() {
      if (selectedRowIndex === null) {
        showModernAlert('Please select a row first', 'warning');
        return;
      }
      
      const alertText = domCache.notes ? domCache.notes.value.trim() : '';
      if (!alertText) {
        showModernAlert('Please enter an alert message', 'warning');
        return;
      }
      
      const criticalAlert = `üö® CRITICAL ALERT: ${alertText}`;
      const currentNotes = domCache.notes ? domCache.notes.value : '';
      
      // Keep critical alert at the top
      let newNotes = criticalAlert;
      if (currentNotes && !currentNotes.includes('üö® CRITICAL ALERT')) {
        newNotes += '\n\n' + currentNotes;
      } else if (currentNotes && currentNotes.includes('üö® CRITICAL ALERT')) {
        // Replace existing critical alert
        newNotes = currentNotes.replace(/üö® CRITICAL ALERT: .+?(?=\n\n|\n|$)/, criticalAlert);
      }
      
      if (domCache.notes) domCache.notes.value = newNotes;
      
      showModernAlert('Critical alert added', 'success');
    }

    function removeCriticalAlert() {
      if (selectedRowIndex === null) {
        showModernAlert('Select a row first.', 'warning');
        return;
      }
      
      const currentNotes = domCache.notes ? domCache.notes.value : '';
      if (!currentNotes.includes('üö® CRITICAL ALERT')) {
        showModernAlert('No critical alert found on this row.', 'info');
        return;
      }
      
      if (!confirm('Remove the critical alert from this row?')) return;
      
      setBusy('.remove-alert-btn', true);
      
      // Remove critical alert from notes
      const newNotes = currentNotes.replace(/üö® CRITICAL ALERT: .+?(?=\n\n|\n|$)/, '').replace(/\n\n+/g, '\n\n').trim();
      
      const data = {
        action: 'edit',
        password: sessionPassword,
        row: selectedRowIndex,
        username: domCache.username ? domCache.username.value.trim() : '',
        passwordField: domCache.passwordField ? domCache.passwordField.value.trim() : '',
        email: domCache.email ? domCache.email.value.trim() : '',
        phone: domCache.phone ? domCache.phone.value.trim() : '',
        server: domCache.server ? domCache.server.value.trim() : '',
        autoPay: domCache.autoPay ? domCache.autoPay.value.trim() : '',
        notes: newNotes
      };

      fetch(scriptURL, {
        method: 'POST',
        body: new URLSearchParams(data)
      })
        .then(res => res.text())
        .then(data => {
          console.log('Remove alert response:', data);
          loadData(true);
          showModernAlert('Critical alert removed successfully.', 'success');
        })
        .catch(err => showModernAlert('Failed to remove critical alert: ' + err, 'error'))
        .finally(() => setBusy('.remove-alert-btn', false));
    }

    // ========== NEW FEATURES ==========
    
    // Undo functionality
    let undoStack = [];
    let maxUndoSteps = 10;
    
    function saveUndoState(action, data) {
      undoStack.push({
        action: action,
        data: data,
        timestamp: Date.now()
      });
      
      // Keep only last N undo steps
      if (undoStack.length > maxUndoSteps) {
        undoStack.shift();
      }
    }
    
    function undoLastChange() {
      if (undoStack.length === 0) {
        showModernAlert('No changes to undo', 'info');
        return;
      }
      
      const lastChange = undoStack.pop();
      
      switch (lastChange.action) {
        case 'add':
          showModernAlert('Cannot undo add operation automatically. Please delete the row manually.', 'warning');
          break;
        case 'edit':
          if (lastChange.data && selectedRowIndex) {
            restoreRowData(lastChange.data);
            showModernAlert('Row data restored', 'success');
          }
          break;
        case 'delete':
          showModernAlert('Cannot undo delete operation automatically. Please add the row back manually.', 'warning');
          break;
        default:
          showModernAlert('Unknown operation type', 'error');
      }
    }
    
    function restoreRowData(data) {
      if (domCache.username) domCache.username.value = data.username || '';
      if (domCache.passwordField) domCache.passwordField.value = data.passwordField || '';
      if (domCache.email) domCache.email.value = data.email || '';
      if (domCache.phone) domCache.phone.value = data.phone || '';
      if (domCache.server) domCache.server.value = data.server || '';
      if (domCache.autoPay) domCache.autoPay.value = data.autoPay || '';
      if (domCache.notes) domCache.notes.value = data.notes || '';
    }
    
    // Modern Alert System
    function showModernAlert(message, type = 'info') {
      // Remove existing alerts
      const existingAlerts = document.querySelectorAll('.modern-alert');
      existingAlerts.forEach(alert => alert.remove());
      
      const alertDiv = document.createElement('div');
      alertDiv.className = `modern-alert modern-alert-${type}`;
      
      const icon = getAlertIcon(type);
      alertDiv.innerHTML = `
        <div class="alert-content">
          <div class="alert-icon">${icon}</div>
          <div class="alert-message">${message}</div>
          <button class="alert-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
        </div>
      `;
      
      document.body.appendChild(alertDiv);
      
      // Auto remove after 5 seconds for non-critical alerts
      if (type !== 'critical') {
        setTimeout(() => {
          if (alertDiv.parentElement) {
            alertDiv.remove();
          }
        }, 5000);
      }
    }
    
    function getAlertIcon(type) {
      switch (type) {
        case 'success': return '‚úì';
        case 'error': return '‚úï';
        case 'warning': return '‚ö†';
        case 'critical': return 'üö®';
        default: return '‚Ñπ';
      }
    }
    
    // Override original alert function to use modern alerts
    const originalAlert = window.alert;
    window.alert = function(message) {
      if (message.includes('CRITICAL ALERT')) {
        showModernAlert(message.replace(/‚ö†Ô∏è CRITICAL ALERT\n\n|\n\nThis alert will remain until manually removed\./g, ''), 'critical');
      } else if (message.includes('Incorrect password')) {
        showModernAlert('Incorrect password', 'error');
      } else if (message.includes('Select a row first')) {
        showModernAlert('Please select a row first', 'warning');
      } else if (message.includes('Username is required')) {
        showModernAlert('Username is required', 'warning');
      } else if (message.includes('Username already exists')) {
        showModernAlert('Username already exists', 'warning');
      } else if (message.includes('Type a note')) {
        showModernAlert('Please enter a note', 'warning');
      } else if (message.includes('Alert message cannot be empty')) {
        showModernAlert('Alert message cannot be empty', 'warning');
      } else if (message.includes('Critical alert saved')) {
        showModernAlert('Critical alert saved', 'success');
      } else if (message.includes('Critical alert removed')) {
        showModernAlert('Critical alert removed', 'success');
      } else if (message.includes('No critical alert found')) {
        showModernAlert('No critical alert found on this row', 'info');
      } else {
        showModernAlert(message, 'info');
      }
    };
    
    // Export functions
    window.undoLastChange = undoLastChange;
    window.showModernAlert = showModernAlert;
    window.addCriticalAlert = addCriticalAlert;
    window.addNewNote = addNewNote;
    window.loadData = loadData;
    window.addRow = addRow;
    window.removeCriticalAlert = removeCriticalAlert;
  </script>
</body>
</html>